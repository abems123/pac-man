version: 2.1

jobs:
  # =========================
  # Auto-format C++ + auto-commit
  # =========================
  format:
    docker:
      - image: cimg/base:24.04
    steps:
      - checkout

      - run:
          name: Install clang-format 18
          command: |
            sudo apt-get update
            sudo apt-get install -y clang-format-18 git

      - run:
          name: Format C++ code
          command: |
            find . -type f \( -name "*.c" -o -name "*.cc" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" \) \
              -not -path "./build/*" \
              -not -path "./cmake-build-*/*" \
              -not -path "./.git/*" \
              -print0 | xargs -0 clang-format-18 -i

      - run:
          name: Auto-commit formatting changes (if any)
          command: |
            if git diff --quiet; then
              echo "No formatting changes."
              exit 0
            fi

            if [ -z "${GITHUB_TOKEN:-}" ]; then
              echo "clang-format produced changes, but GITHUB_TOKEN is not set in CircleCI."
              echo "Set a GitHub token with write access as GITHUB_TOKEN to enable auto-commit."
              git --no-pager diff
              exit 1
            fi

            git config user.name "circleci"
            git config user.email "circleci@users.noreply.github.com"

            git add -A
            git commit -m "style: auto-format C++ code with clang-format-18"

            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git"
            git push origin "HEAD:${CIRCLE_BRANCH}"

  # =========================
  # Full project build (with SFML)
  # =========================
  build:
    docker:
      - image: cimg/base:24.04

    steps:
      - checkout

      - run:
          name: Install build dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              build-essential \
              cmake \
              g++-13 \
              clang-18 \
              libsfml-dev

      - run:
          name: Verify toolchain versions
          command: |
            cmake --version
            g++ --version
            clang++-18 --version
            dpkg -l | grep libsfml || true

      - run:
          name: Configure (CMake)
          command: |
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - run:
          name: Build
          command: |
            cmake --build build --parallel

  # =========================
  # Logic-only build (Debug, no SFML, no tests)
  # =========================
  build_logic_debug:
    docker:
      - image: cimg/base:24.04
    environment:
      BUILD_TYPE: Debug
      SOURCE_DIR: logic
    steps:
      - checkout

      - run:
          name: Install dependencies (no SFML)
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              build-essential \
              cmake \
              g++-13

      - run:
          name: Configure CMake for 'logic'
          command: |
            cmake -S "${SOURCE_DIR}" -B build_logic -DCMAKE_BUILD_TYPE="${BUILD_TYPE}"

      - run:
          name: Build 'logic'
          command: |
            cmake --build build_logic --parallel

workflows:
  build_and_format:
    jobs:
      - format:
          filters:
            branches:
              only: [ main, master, develop ]

      - build:
          filters:
            branches:
              only: [ main, master, develop ]

      - build_logic_debug:
          filters:
            branches:
              only: [ main ]
