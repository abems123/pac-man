version: 2.1

executors:
  ubuntu_24_04_frozen:
    docker:
      - image: cimg/base:24.04
    environment:
      DEBIAN_FRONTEND: noninteractive
      UBUNTU_SNAPSHOT_ID: "20250807T000000Z"
      STRICT_CLANG_PATCH: "false"

jobs:
  build:
    executor: ubuntu_24_04_frozen
    parameters:
      toolchain:
        type: enum
        enum: ["gcc", "clang"]
    steps:
      - checkout

      - run:
          name: Freeze Ubuntu APT repos to snapshot (disable third-party repos first)
          command: |
            set -eux

            # Remove any pre-enabled third-party repositories in the convenience image
            sudo rm -f /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources || true

            SNAP="${UBUNTU_SNAPSHOT_ID}"
            sudo tee /etc/apt/sources.list >/dev/null <<EOF
            deb https://snapshot.ubuntu.com/ubuntu/${SNAP} noble main universe multiverse restricted
            deb https://snapshot.ubuntu.com/ubuntu/${SNAP} noble-updates main universe multiverse restricted
            deb https://snapshot.ubuntu.com/ubuntu/${SNAP} noble-security main universe multiverse restricted
            deb https://snapshot.ubuntu.com/ubuntu/${SNAP} noble-backports main universe multiverse restricted
            EOF

            sudo apt-get update -y

      - run:
          name: Install build dependencies (from snapshot)
          command: |
            set -eux
            sudo apt-get install -y --no-install-recommends \
              ca-certificates \
              build-essential \
              ninja-build \
              pkg-config \
              cmake \
              libsfml-dev \
              gcc-13 g++-13

            # Make sure "gcc/g++" points to GCC 13
            sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
            sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
            sudo update-alternatives --set gcc /usr/bin/gcc-13
            sudo update-alternatives --set g++ /usr/bin/g++-13

      - when:
          condition:
            equal: [clang, << parameters.toolchain >>]
          steps:
            - run:
                name: Install Clang 18
                command: |
                  set -eux
                  # Install clang-18 from Ubuntu snapshot (reproducible).
                  # Note: on Noble this is typically 18.1.x, not 18.0.0.
                  sudo apt-get install -y --no-install-recommends clang-18

      - run:
          name: Verify required versions (fail if mismatch)
          command: |
            set -eux
            echo "OS:"; cat /etc/os-release | sed -n '1,6p'

            echo "CMake:"; cmake --version | head -n1
            cmake --version | head -n1 | grep -F "3.28.3"

            echo "G++:"; g++ --version | head -n1
            g++ --version | head -n1 | grep -F "13.2.0"

            echo "SFML:"; dpkg-query -W -f='${Package} ${Version}\n' libsfml-dev
            dpkg-query -W -f='${Version}\n' libsfml-dev | grep -E '^2\.6\.1'

            if [ "<< parameters.toolchain >>" = "clang" ]; then
              echo "Clang:"; clang++-18 --version | head -n1
              if [ "${STRICT_CLANG_PATCH}" = "true" ]; then
                clang++-18 --version | head -n1 | grep -E '^clang version 18\.0\.0\b'
              else
                clang++-18 --version | head -n1 | grep -E '^clang version 18\.'
              fi
            fi

      - run:
          name: Configure (CMake)
          command: |
            set -eux
            if [ "<< parameters.toolchain >>" = "clang" ]; then
              cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_C_COMPILER=clang-18 -DCMAKE_CXX_COMPILER=clang++-18
            else
              cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_C_COMPILER=gcc-13 -DCMAKE_CXX_COMPILER=g++-13
            fi

      - run:
          name: Build
          command: |
            set -eux
            cmake --build build --parallel

      - run:
          name: Run tests (if any)
          command: |
            set -eux
            ctest --test-dir build --output-on-failure || true

workflows:
  build_and_test:
    jobs:
      - build:
          matrix:
            parameters:
              toolchain: ["gcc", "clang"]
